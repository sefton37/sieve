{% extends "base.html" %}

{% block title %}Daily Digest - Sieve{% endblock %}

{% block content %}
<h1>Daily Digest</h1>
<p class="stats">
    Abend's morning briefings on the attention extraction economy.
    {% if next_digest_run %}
    <br><small>Next scheduled: <strong>{{ next_digest_run|format_date }}</strong></small>
    {% endif %}
</p>

<!-- Job Status -->
<section id="job-status" hx-get="{{ url_for('job_status') }}" hx-trigger="every 2s" hx-swap="innerHTML">
    {% include "partials/job_status.html" %}
</section>

<!-- Generate Button -->
<section>
    <button
        hx-post="{{ url_for('trigger_digest') }}"
        hx-target="#job-status"
        hx-swap="innerHTML"
        class="primary"
    >
        Generate Today's Digest
    </button>
</section>

<hr>

<!-- Recent Digests -->
<section>
    <h2>Recent Briefings</h2>

    {% if digests %}
    {% for digest in digests %}
    <article class="digest-card">
        <header>
            <strong>{{ digest.digest_date }}</strong>
            <small>{{ digest.article_count }} articles</small>
        </header>
        <div class="digest-content markdown-body" data-markdown="{{ digest.content|e }}"></div>
        <footer>
            <small>Generated {{ digest.created_at|format_date }}</small>
        </footer>
    </article>
    {% endfor %}
    {% else %}
    <article>
        <p>No digests yet. Click "Generate Today's Digest" to create your first briefing.</p>
    </article>
    {% endif %}
</section>

<!-- Marked.js for markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configure marked for safe rendering
    marked.setOptions({
        breaks: false,
        gfm: true
    });

    // Render all markdown content
    document.querySelectorAll('.markdown-body[data-markdown]').forEach(function(el) {
        const markdown = el.getAttribute('data-markdown');
        el.innerHTML = marked.parse(markdown);
    });
});
</script>

<style>
.digest-card {
    padding: 1.25rem;
    margin-bottom: 1.25rem;
    border-left: 4px solid #5b7a9d;
    background: #faf8f5;
    border-radius: 4px;
}

.digest-card header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0;
}

.digest-card header strong {
    color: #3d5a73;
}

.digest-content {
    line-height: 1.55;
    color: #2c3e50;
}

.digest-content h1,
.digest-content h2,
.digest-content h3,
.digest-content h4,
.digest-content h5,
.digest-content h6 {
    margin-top: 0.8rem;
    margin-bottom: 0.2rem;
    padding: 0;
}

.digest-content h2 {
    font-size: 1.15rem;
    color: #3d5a73;
    border-bottom: 1px solid #d4cfc7;
    padding-bottom: 0.25rem;
}

.digest-content h3 {
    font-size: 1.05rem;
    color: #4a6741;
}

.digest-content p {
    margin-top: 0;
    margin-bottom: 0.35rem;
}

.digest-content ul, .digest-content ol {
    margin-top: 0.1rem;
    margin-bottom: 0.25rem;
    padding-left: 1.5rem;
}

.digest-content li {
    margin-bottom: 0.15rem;
}

.digest-content blockquote {
    margin: 0.4rem 0;
    padding: 0.4rem 0.8rem;
    border-left: 3px solid #8fa8c2;
    background: #f0ece6;
    border-radius: 2px;
    font-style: italic;
    color: #4a5568;
}

.digest-content blockquote p {
    margin-bottom: 0.1rem;
}

.digest-content hr {
    margin: 0.75rem 0;
    border-color: #d4cfc7;
}

.digest-content > *:first-child {
    margin-top: 0;
}

.digest-content a {
    color: #6b4c8a;
    text-decoration: underline;
    text-decoration-color: #c4b5d4;
    text-underline-offset: 2px;
}

.digest-content a:hover {
    color: #523a6b;
    text-decoration-color: #8a6aaf;
}

.digest-content strong {
    color: #2c3e50;
}

.digest-card footer {
    margin-top: 1rem;
    padding-top: 0.5rem;
    border-top: 1px solid #d4cfc7;
    color: #7a8a97;
}
</style>
{% endblock %}
